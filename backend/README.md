# Backend часть сервиса bodyfuel
## Краткая инструкция быстрого старта
1. Сваггер документация развернута по адресу http://localhost:8080/swagger/index.html (при запросе к продовой части нужно хост (localhost) заменить на продовый)
2. На данный момент разворачивается minio для хранения изображений и поэтому гайд как развернуть для корректной работы:
   1. Необходимо у себя в терминале запустить докер образ minio: `docker run -p 9000:9000 minio/minio server /data`, 
   2. Далее необходимо подключиться к образу минио (рекомендуется через десктоп версию) и ввести следующие команды: `mc mb local/avatars` - для создания бакета с хранением аватарок, `mc anonymous set public local/avatars` - для полного доступа клиентской части к бакету с хранением информации
3. Также необходимо иметь запущенный `postgresql`, данные которого надо указать в конфиге для корректного взаимодействия.
4. Перед стартом необходимо создать (если его нет) или убедиться в правильности заполненных параметров файла `./config/config.yaml`, c шаблоном можно ознакомиться в файле `.config/config.yaml.template`

## Архитектура сервиса
Архитектура backend части сервиса bodyfuel представлена в виде большого микросервиса, где каждые части разделены на домены, с использованием DDD + CA. Все слои разделены и работают независимо друг от друга, используя абстракцию (интерфейсы). Через абстракцию происходит взаимодействие внешних слоев со внутренними. А содержит следующие слои:
1. **Слой API/Handlers** - обрабатывает HTTP запросы
2. **Слой сервисов/Usecases** - вся бизнес логика приложения
3. **Слой доменной бизнес логики** - вся бизнес логика домена
4. **Слой инфраструктуры** - доступ к данным напрямую через этот слой происходит

### Описание сервисов
1. **Auth** - сервис для авторизации и аутентификации пользователя
2. **Avatar** - сервис для выдачи ссылки для загрузки фотографии для клиетской части
3. **CRUD** - сервис содержащий в себе все CRUD операции для каждой модели в базе данных
4. **Executor** - сервис выполняющий отложенные задачи сервиса (в основном обрабатывает задачи отправки уведомлений пользователю)
5. **Nutricion** - сервис который обрабатывает и генерирует питание для пользователя
6. **Workouts** - сервис отвечающий за тренировочный план пользователя

## База данных

### Схема базы данных

Сервис использует PostgreSQL для хранения информации внутри сервиса `bodyfuel`. Ниже описание каждого параметра в схеме bodyfuel.

#### Таблица `user_info`

Хранит чувствительную информацию о пользователе.

| Название   | Тип       | Описание                    | Индекс        |
|------------|-----------|-----------------------------|---------------|
| id         | UUID      | Первичный ключ              | idx_user_info |
| username   | TEXT      | Никнейм пользователя        | -             |
| name       | TEXT      | Имя пользователя            | -             |
| surname    | TEXT      | Фамилия пользователя        | -             |
| password   | TEXT      | Пароль пользователя         | -             |
| email      | TEXT      | Почта пользователя          | -             |
| phone      | TEXT      | Номер телефона пользователя | -             |
| created_at | TIMESTAMP | Время создания аккаунта     | -             |

#### Таблица `user_params`
Хранит информацию о параметрах пользователя и необходимой цели (вес, образ жизни, целевые показатели).

| Название                | Тип                        | Описание                                             | Индекс           |
|-------------------------|----------------------------|------------------------------------------------------|------------------|
| id                      | UUID                       | Первичный ключ                                       | pk_user_params   |
| id_user                 | UUID                       | Внешний ключ к таблице user_info (ON DELETE CASCADE) | -                |
| height                  | INT                        | Рост пользователя в см                               | -                |
| photo                   | TEXT                       | Ссылка на аватар/фото (в MinIO)                      | -                |
| wants                   | bodyfuel.want (ENUM)       | Цель: похудеть, набрать массу, поддерживать форму    | -                |
| lifestyle               | bodyfuel.lifestyle (ENUM)  | Образ жизни: малоактивный, активный, спортивный      | -                |
| target_workouts_weeks   | INT                        | Целевое количество тренировок в неделю               | -                |
| target_calories_daily   | INT                        | Целевая дневная норма калорий                        | -                |
| target_weight           | FLOAT                      | Целевой вес (кг)                                     | -                |

#### Таблица `user_weight`
Хранит историю изменений веса пользователя.

| Название | Тип                      | Описание                                             | Индекс          |
|----------|--------------------------|------------------------------------------------------|-----------------|
| id       | UUID                     | Первичный ключ                                       | pk_user_weight  |
| id_user  | UUID                     | Внешний ключ к таблице user_info (ON DELETE CASCADE) | -               |
| weight   | FLOAT                    | Вес пользователя в кг                                | -               |
| date     | TIMESTAMP WITH TIME ZONE | Дата и время измерения (по умолчанию текущее)        | -               |

#### Таблица `exercise`
Хранит список возможных упражнений 

#### Таблица `tasks`
Хранит мета-данные для сервиса executor для выполнения отложенной задачи.
